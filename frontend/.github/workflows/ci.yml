name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # 1. バックエンドのテスト
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest httpx
          
      - name: Run Pytest
        run: |
          cd backend
          pytest tests/
          
  # 2. フロントエンドのテスト
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run Vitest
        run: npm test -- run # --run でウォッチモードを無効化

  # 3. デプロイ (テストが全部パスした場合のみ)
  deploy:
    needs: [test-backend, test-frontend] # ここが重要！テスト成功を待つ
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # mainブランチへのプッシュ時のみ
    steps:
      - uses: actions/checkout@v4
      
      # Vercelへのデプロイ
      # 事前にGitHub Secretsに VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID を設定する必要があります
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod' # 本番デプロイ